// =========================================================================
// Plugin Declaration
// =========================================================================

plugins {
    id 'com.github.ben-manes.versions' version '0.17.0'
    id 'org.springframework.boot' version '1.5.10.RELEASE'
}

apply plugin: 'eclipse'
apply plugin: 'idea'
apply plugin: 'jacoco'
apply plugin: 'java'
apply plugin: 'maven'
apply plugin: 'war'

// =========================================================================
// Project Information
// =========================================================================

description = 'A simple web application illustrating how to structure a SpringMVC project.'

// =========================================================================
// Project Attributes
// =========================================================================

sourceCompatibility = 1.8
targetCompatibility = 1.8 

repositories {
    mavenCentral()
}

// =========================================================================
// Dependency Management
// =========================================================================

ext['logback.version'] = '1.2.3'
ext['jackson.version'] = '2.9.4'
ext['slf4j.version'] = '1.7.25'
ext['spring.version'] = '4.3.14.RELEASE'

dependencies {
    // OWASP Sanitizer
    implementation group: 'com.googlecode.owasp-java-html-sanitizer', name: 'owasp-java-html-sanitizer', version: '20171016.1'

    // Spring Boot
    implementation group: 'org.springframework.boot', name: 'spring-boot-starter-web'
    testImplementation group: 'org.springframework.boot', name: 'spring-boot-starter-test'
    
    // Apache Tomcat
    providedRuntime group: 'org.apache.tomcat.embed', name: 'tomcat-embed-jasper'
    providedRuntime group: 'org.springframework.boot', name: 'spring-boot-starter-tomcat'

    // Java Servlet
    compileOnly group: 'javax.servlet', name: 'javax.servlet-api', version: '3.1.0', force: true
    compileOnly group: 'javax.servlet.jsp', name: 'javax.servlet.jsp-api', version: '2.3.1', force: true
    implementation group: 'javax.servlet', name: 'jstl', version: '1.2'
}

// =========================================================================
// Task Type Configuration
// =========================================================================

tasks.withType(JacocoReport) {
    reports.xml.enabled true
}
check.dependsOn tasks.withType(JacocoReport)

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    options.compilerArgs << '-Xlint:unchecked' << '-Xlint:deprecation'
}

tasks.withType(Test) {
    jacoco.append = false
    systemProperties['java.io.tmpdir'] = temporaryDir.absolutePath
}

// =========================================================================
// Plugin Task Configuration
// =========================================================================

jacoco {
    toolVersion = '0.8.0'
}

processResources {
    expand(project.properties)
}

springBoot {
    backupSource = false
}

wrapper {
    distributionType = Wrapper.DistributionType.ALL
    gradleVersion = '4.6'
}

// =========================================================================
// Custom Task Definitions
// =========================================================================

task stage(type: Copy, dependsOn: 'assemble') {
    from war.archivePath
    into temporaryDir
    rename (war.archiveName, 'app.war')
}
